#!/bin/zsh
set -Ceu
ffmpeg=$HOME/bin/ffmpeg_
IFS=$'\n'
LOG=encode.log

if [ ! -e $LOG ]; then
	touch $LOG
else
	echo "" >> $LOG
fi

function encoding () {
	for file in `find . -maxdepth 1 -name '*.ts'`; do
		if [ ! -e "${file%ts}webm" ]; then
			echo "${file}" >> $LOG
			echo "`date`" >> $LOG
			$ffmpeg -n -i $file -c:v libvpx-vp9 -c:a libopus \
			-vpre vp9-testing \
			-vf bwdif=1:-1:1 -crf 31 "${file%ts}webm"
			echo "`date`\n" >> $LOG
		else
			sleep 2s
		fi
	done
}

while true
do
	encoding
done

# Comment
#	reference: https://developers.google.com/media/vp9/settings/vod/
# CRF
#	720:  32
#	1080: 31

